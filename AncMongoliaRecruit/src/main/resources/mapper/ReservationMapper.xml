<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.crewfactory.main.dao.ReservationDao">

	<select id="select" parameterType="com.crewfactory.main.domain.ReservationDomain" resultType="com.crewfactory.main.domain.ReservationDomain">
		SELECT 
			a.idx, a.cons_status, a.cus_name, a.cus_age, a.cus_mobile, a.rec_manager, a.cons_day, a.cons_time, a.cons_manager, a.regid, a.regdate,
			fn_getManagerNm(cons_manager) as cons_manager_nm,
			(select memo from ck_consult_history_info where consult_idx = a.idx order by idx desc limit 1) as memo
		FROM ck_consult_info a
		<trim prefix="WHERE" prefixOverrides="AND||OR">
			<if test = "cons_status != null">
				AND a.cons_status = #{cons_status}
			</if>
			<if test = "cons_manager != null">
				AND a.cons_manager = #{cons_manager}
			</if>
		</trim>
		ORDER BY a.cons_day DESC, a.cons_time DESC
	</select>
	
	<select id="view" parameterType="int" resultType="com.crewfactory.main.domain.ReservationDomain">
		SELECT 
			*
		FROM ck_consult_info where idx = #{idx};
	</select>
	
	<insert id="insert" parameterType="com.crewfactory.main.domain.ReservationDomain">
		INSERT INTO ck_consult_info (idx, cons_status, cus_name, cus_mobile, rec_manager, cons_day, cons_time, cons_manager, regid, regdate)
		VALUES((select ifnull(max(idx)+1, 1) from ck_consult_info a), #{cons_status}, #{cus_name}, #{cus_mobile}, #{rec_manager}, #{cons_day}, #{cons_time}, #{cons_manager}, #{regid}, now())
	</insert>
	
	<update id="update" parameterType="com.crewfactory.main.domain.ReservationDomain">
        UPDATE ck_consult_info
			SET
			cons_status=#{cons_status},
			cons_day=#{cons_day},
			cons_time=#{cons_time},
			cons_team=#{cons_team},
			cons_manager=#{cons_manager},
			regid=#{regid},
			regdate=#{regdate}
		WHERE idx = #{idx};
    </update>
    
    <insert id="updateMemo" parameterType="com.crewfactory.main.domain.ReservationDomain">
		INSERT INTO ck_consult_memo_info (idx, cons_idx, cons_memo, regid, regdate)
		VALUES(
			(select ifnull(max(idx)+1, 1) from ck_consult_info a), 
			#{cons_idx},
			#{cons_memo}, 
			#{regid}, 
			now()
		)
	</insert>
        
    <delete id="delete" parameterType="int">
        DELETE FROM faq WHERE idx = #{idx}
    </delete>

</mapper>